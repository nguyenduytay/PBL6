import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from .Driver import Driver
from src.Models.Malware import Malware
import json
import os

driver = Driver()

async def get_all_malware() -> list[Malware]:
    db = await driver.connect()
    cursor = db.cursor()
    res = []
    cursor.execute("SELECT * FROM malwares")
    for row in cursor.fetchall():
        res.append(mapping_data(row))
    return res

async def get_malware_by_field(field: str, value: str) -> Malware | None:
    db = await driver.connect()
    cursor = db.cursor()
    query = f"SELECT * FROM malwares WHERE {field}=%s"
    cursor.execute(query, (value,))
    result = cursor.fetchone()
    return mapping_data(result) if result else None

async def get_malware_by_list(field: str, values: list[str]) -> list[Malware]:
    db = await driver.connect()
    cursor = db.cursor()
    placeholders = ', '.join(['%s'] * len(values))
    query = f"SELECT * FROM malwares WHERE {field} IN ({placeholders})"
    cursor.execute(query, values)
    return [mapping_data(row) for row in cursor.fetchall()]

async def get_malware_by_list_sha256(sha256_list: list[str]) -> list[Malware]:
    """Tìm malware theo danh sách SHA256 từ JSON file"""
    try:
        # Đọc từ JSON file thay vì database
        json_path = os.path.join(os.path.dirname(__file__), "Malware.json")
        if not os.path.exists(json_path):
            return []
        
        with open(json_path, 'r', encoding='utf-8') as f:
            malware_data = json.load(f)
        
        results = []
        for malware in malware_data:
            if malware.get('sha256') in sha256_list:
                results.append(Malware(
                    _id=malware.get('_id', ''),
                    fileType=malware.get('fileType', ''),
                    firstSeen=malware.get('firstSeen', ''),
                    md5=malware.get('md5', ''),
                    mimeType=malware.get('mimeType', ''),
                    name=malware.get('name', ''),
                    sha1=malware.get('sha1', ''),
                    sha256=malware.get('sha256', ''),
                    sha384=malware.get('sha384', ''),
                    malwareType=malware.get('malwareType', ''),
                ))
        
        return results
    except Exception as e:
        print(f"Error reading malware data: {e}")
        return []

def mapping_data(item) -> Malware:
    return Malware(
        _id=item[0],
        fileType=item[1],
        firstSeen=item[2],
        md5=item[3],
        mimeType=item[4],
        name=item[5],
        sha1=item[6],
        sha256=item[7],
        sha384=item[8],
        malwareType=item[9],
    )
